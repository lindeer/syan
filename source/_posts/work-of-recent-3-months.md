title: 最近三个月的忙活
date: 2022-11-02 10:25:58
category: Life
---

转眼到11月份了，时间过得很快。工作项目已经进入到了开发阶段，个人项目目前看也基本达到了可用的程度，希望付出没有白费。

### gitbook的dart实现

`dartbook`的开发持续到了8月初，因为一些依赖库上的原因没有办法继续。dart的生态确实还有待完善，缺少很多库，或者就是存在的库没法开箱即用，这是一次直观的比较。而且越写dart越觉得kotlin非常舒服，曾经萌生再用kotlin实现一遍gitbook，准备叫它`kotbook`。需要完善的库有2个：1. dart语言的markdown库不支持脚注，而脚注在文章中是非常常见的。2. 缺少ignore库，一个可以解析文本规则的库，js有[ignore](https://www.npmjs.com/package/ignore)库可以直接拿来用，但dart就比较费劲。即使要自己实现，我看处理`*`、`**`和`/`并不容易。

### dart-markdown库支持footnote

官方库不支持脚注，这的确是个让人不满的地方，我索性心一横准备改源码作提交！考虑到将来要完成一款markdown语言所见即所得的编辑器（结合typera和“我来”），熟悉markdown的实现这个工作迟早要搞，而且一直以来我居然没有给开源项目提交过任何代码，所以准备搞一把！于是殚精竭虑地看`markdown-it`和`pandoc`的源码实现和用例示例，花了十来天[提交](https://github.com/dart-lang/markdown/pull/441)了一版，我当然知道肯定还需要更精细的优化，但是想着可以边评审边修改，就别先自己蒙头搞。但没想到这个过程实在太难受了。

这个功能之前已经有人提过了，库的维护者[srawlins](https://github.com/srawlins)表示愿意接受其他人的贡献，同时列举了pandoc的例子，于是我就按照pandoc的规范，markdown-it的实现完成的这一版，可是那个叫的srawlins家伙拖着根本不进行代码评审；我一看其它的一些提交，也都是放置了好几个月，于是干脆也放着。又过了快2个星期，这个提交引起了另一个开发者的注意，我俩互相回复了一下，这时srawlins终于也回复了，表示这个功能应当按照github的规范。行吧，我觉得问题不大，然后我不仅找了github的示例，还连同代码一起下载研究，仔细运行了代码，对比了用例，然后提交上去，结果又没音了。直至8月底，这家伙才又开始review。但这个时候我发现我的一些改动也不是很合适，于是建议先放弃这个改动，另开两个新的提交，一个提交属于改造性质，另一个提交是基于这个提交的功能增加。他答应先开启那个用于改造的[新提交](https://github.com/dart-lang/markdown/pull/452)，而老的提交先保留。我照做了，可是接下来的却是遥遥无期的漫长等待，新开的提交里这个王八蛋说得要等flutter_markdown的6.0.0发布之后再合并这个提交，真是奶奶的。过了一个月，我看flutter_markdown的6.0.0已经发布了，就提醒他，结果他说要再等一星期，当前这个库的6.0.0满60天再考虑。等到满60天了我再提醒这个王八蛋，这个乌龟已经不回复了。妈的，一遍遍折腾老子，关键是一拖再拖，老是破坏我的预期，这帮家伙可能根本就不想接受外来的提交，滚他娘的开源！后来，实在憋得受不了了，最后一遍问他到底有没有希望合并这个2个月前的提交。这家伙终于回复了，明确表示这个提交优先级不高，不能合并。我终于放弃了，准备不再天天挂念想这个提交，这时已经到了10月18日。没想到的是，过了一个周末星期一因为查看邮箱发现了github的推送，我一看用于改造的新提交已经review过了，需要再做一些改动。于是我赶紧做了修改，再次提交。然后看了一下日期，原来他在最后一次回复我说优先级不高的第二天就review了这个提交，真是故意折腾我啊，消耗了我无数热情之后，又一次次地给我希望，真想宰了这个王八蛋。我之前以为他很忙，还在github上追踪了一下这个王八蛋的提交记录，这家伙有时间在其他的库里做优化，不愿意多做这些代码评审。终于这个小提交合并进去了，我赶紧把老提交变基，继续修改了一些自动化提示的问题，然而这个提交不再有任何变化了，只能继续等2个月之后再说。

真是一次让人窝火的提交经历。开发dartbook库的过程中也给jinja库作过一些提交，这就很顺畅。不过jinja库基本无人问津，作者对外来提交如获至宝，客客气气也积极回复，唉，到哪都是物以稀为贵。

### 网页开发

因为受到“我来”文档的启发，想把注释(annotation)变成工具条(tooltip)的形式，这样可以直接在当前页查看内容，而且避免网页跳转和一些代码bug。于是研究了一下如何在网页中弹出工具条，主要参考w3school的[示例](https://www.w3school.com.cn/css/css_tooltip.asp)，涉及到很多CSS的内容，这个过程有点痛苦，web的界面和差别很大，让人很不适。整体效果不错，可是一些边缘情况让人不是很满意，这才意识到为什么那么多工具条没有用CSS而是纯代码的方式：需要弹出的工具条弹窗避免被裁剪。7月底只完成了css形式的工具条，没有找到更好的工具条js库，因为还要试用，集成，让人有点烦躁。

突然想到：既然flutter已经支持了web平台开发，为什么不用flutter来完成dartbook的界面开发呢？这样能完全避免js开发框架，还能以自己熟悉的方式快速构建界面与功能。这个想法让我非常兴奋，于是花了不少时间作了一番研究。然而最后的结论是：不行。flutter支持的web开发其实是一种单页面应用(SPA)，适合在单个页面上有很多交互操作的应用，虽然形式上也能做成静态页面；但dartbook将要生成的网站需要很多不同的页面，然后在这些不同页面之间以链接的形式跳转，单个的页面并没有很多的交互，这种叫做“静态网页生成”。如果页面要支持dart开发，则需要以dart支持的webdev的方式进行开发。也就是说，dart语言直接作为界面开发的语言，然后转成js嵌入在页面中。这种方式应当是dartbook未来采取的方式，但意味着现有的一切js库都需要被重写。所以情况就变成：flutter没有提供静态页面生成的开发模式，但是用webdev只能把交互语言替换成dart，现有的js依赖库都需要重写，而描述页面结构和用户界面还是html+css。再次印证了dart的开发生态还不是很完善。现在完全没有用dart操作过html节点和css方法，这一套还得再去学习。

调研过程中偶然发现了[jaspr](https://github.com/schultek/jaspr)这个工具库，几乎完美契合当前的需要，唯一美中不足的是这个库还在开发阶段，目前还不支持静态页面生成。一旦这个功能完成了，那网页结构也可以用dart语言表示，即“SSR”，现在引用的模板库就可以立即丢弃。

### 接触新服务端框架

时间已经到了9月初，在发现jaspr的同时，还发现了另外一个新的服务端框架。因为想用flutter来作网页开发，自然也想到了之前就听闻过的也可以用kotlin作跨平台开发的kotlin-compose，令人惊喜的是发现compose不仅已经支持网页开发，它还附带了一套新的服务端框架ktor。之前一直有在考虑用kotlin作服务端的开发，以为spring boot是不二之选，最大程度地让kotlin语言和框架无缝集成，没想到已经存在kotlin开发的服务端框架了。我立即上手体验了一下ktor，整体感觉很清新，最大的特点是以组合的方式完成功能集成。我不需要再去学习spring那坨无数人已经用烂的东西，更愿意去学习和了解新东西。以后用到服务器就都用ktor了！

ktor另一个好处是集成了非常多的已有框架，比如模板引擎；我发现ktor还不支持jinja模板，于是还专门提了[一个issue](https://youtrack.jetbrains.com/issue/KTOR-4850/Support-Jinjava-template-engine)！以后开发kotbook的时候自然就可以用到了。更妙的是，ktor可以支持ssr也可以支持静态网页生成，用kotlin代码作为DSL表示页面，然后再用kotlin写前端代码，而前端代码又内置了react框架还用到了协程，这样构建了一整套完整的开发体系。这样一个开发体系整合了开后端各领域，绝对是革命性的！

### 在线文档二次开发

目前为止已经牵扯了很多东西了，虽然对ktor很感兴趣，但是没有继续用kotlin新建工程，否则战线就拉得太长了，而且已有的工程还不够完善。于是仅仅用ktor建了几个模板工程，以便在需要新建工程的时候可以直接拿来用。时间已到了9月上旬，这段时间对在线文档也是一直念念不忘。在线文档本身来源于自己的实际需要，首先就是在linux机器上没有好用的office软件，已有的软件笨重无比，一直希望有一款网页版的office文档，无需安装，多人协同。然后就在8月底发现了onlyoffice，并且使用它的docker容器，几乎是一键运行，令人兴奋。美中不足的是，onlyoffice只提供了文档服务器，这个服务器只是用来处理文档的展示，编辑，保存等相关的操作，运行的应用也只是它的示例程序，不能新建目录，因而也不能导航。相当于，onlyoffice分离了文档操作和外部输入，需要使用者在这个基础上做二次开发（我后来才意识到自己没有发现onlyoffice的社区服务器，看起来这个服务提供了一揽子的多人协同功能，也包括了文档的组织功能，但已经没有兴趣再搞了）。

于是立即萌发了一个激动人心的想法：基于示例程序开发一个能够生成目录并进行导航的在线文档服务器，相当于自己开发一个文件浏览器，展示和编辑文件则交给已有的文档服务器。示例程序有多种语言实现，选择了简单易懂的python工程；然后在这个基础上再修改，但是改着改着发现难以为继，再加上python让人厌恶，干脆一不做二不休自己从头再搞一个dart语言实现的版本！目录导航其实只需要页面中间的内容变化，如果每次进目录都把网页的全部内容从服务器传过来耗费不说当前页面的很多状态数据会丢失；这是典型的单页面应用场景，妥妥地得用flutter呀；而展示文档的页面需要把外部数据灌入模板文件，实际就是服务器动态生成网页；终于把这一切给整合统一起来了，以前了解的东西终究没有白费～于是又开了一个新工程`cloudoc`，先搞文件浏览器，这是个前后端结合的全栈功能，相比ktor，flutter给人的感觉还是不够便利；接着就是接入onlyoffice的各种接口。这部分麻烦的地方在那个track接口，文档服务器调用这个接口的时机不定，数据也不定，没法完整正确地形成历史数据，但整体上到10月上旬已经可以在网面上打开并编辑文档了，真是让人欣喜。

### 《罗马城中世纪史》翻译

`cloudoc`基本完成之后已到了10月中旬，终于想起了停止许久的翻译工作。最后一次改动停在半年前，还是在滴滴的时候，让人有点感叹。到10月底一共翻译11个章节，了好几万字；除了一些让人不解的地方，所有翻译参照的都是英文翻译，没有直接翻译自德语原文，格雷的书写的还是很通俗易懂的。久远的故事再次栩栩如生地呈现，这两个多星期的翻译让人觉得内心充实。罗马城的故事和众多人的命运让人浩然长叹。因为最开始只想了解康拉丁的细节，所以翻译材料只准备了从曼弗雷德当上西西里国王到康拉丁身死国灭这一段，但原书卷帙浩繁，故事精彩纷呈，留待我余生慢慢享受了。在运行翻译工程的过程中，完善了dartbook的一些缺失的功能，还解决了一些缺陷，但有几个设计和实现的问题得大改一下才行了。

这么一看也搞了不少东西呢，希望自己有一个质的飞跃，其实这四个多月以来的开发工作基本都是围绕着翻译这个最终目的进行的，可以说是这些基础技术工作的汇总和应用。我需要一个便利的所见即所得的markdown编辑器；把这些markdown文件汇总生成一个静态网站进行展示，这需要有美观的界面和新颖的交互；将来也需要将它们生成电子书；这些生成的电子书会被托管在定制的文档服务器上，方便浏览，打开，编辑和保存；更进一步则需要用户账户系统，权限与数据管理，这些常规的服务器功能当然准备用ktor来实现啦。

18:24
