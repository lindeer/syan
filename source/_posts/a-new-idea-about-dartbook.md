title: dartbook新思路
date: 2022-07-24 21:24:58
category: Tech
---

今天下午的时候终于把dartbook里`JSContext`那部分数据注入完成了，这样我的dartbook运行起来终于有模有样。数据注入完成，加载资源和主题也完成，剩余的就是照猫画虎完成词汇表，也就是js代码中的Modifier那部分了。最大的缺点就是不带插件系统，不能像原来的gitbook那样动态加载可执行代码。非要实现插件系统也不是不可能，但感觉非常的琐碎。

晚上吃饭的时候，一个点子突然击中了我。本来我是在考虑如何设计一套机制，能让用户更加方便地自定义书页的各种样式。特别是将来要完成的术语表，我期望在文中的`Glossary`效果不是像gitbook那样一个简单链接，而是像wolai那样更加高级上的效果：在桌面浏览器上呈现的是悬浮窗（悬浮窗四周还有好看的阴影效果），在手机上则是一个底部弹窗。也许这只是一个CSS效果的事，可对于不熟悉这套知识的我来说，感觉比较棘手。gitbook中的CSS看起来和js的代码绑定的比较紧密，除了要改动css之外，js和html模板应该也需要改动（当前书页中的术语对应的内容需要生成在当前页中）。如果真要实现，思路也不是没有，只要把当前页中涉及的术语内容生成[弹窗样式](https://www.w3schools.cn/css/css_tooltip.asp)，并用js将文本中的术语与弹窗关联起来即可。但是我一瞬间一个念头敲击了我，为啥不用flutter来实现界面效果呢，为什么还要去了解自己不熟悉的巨大而未知的领域而舍弃自己本来非常熟悉的世界呢，这正是为我所用的绝好时机呀！

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16b4ecc0fe2540ec840ee4e652412855~tplv-k3u1fbpfcp-watermark.image?)

我立刻激动了起来。如果用了flutter不仅充分利用了自己的优势，不用再和CSS纠缠，而且可以和已有的gitbook形成一个巨大的差异化存在，关键是flutter本身就带有异常丰富的界面组件，各种效果可以说不一而足，也充分利用了当前最新框架的优势，須知gitbook已经有6年没有再更新了。我真后悔自己为什么没有早想到这点，白白浪费一个月的实现和gitbook缠斗。我立即思索一个问题：如果用了flutter作书页的呈现界面，我要怎么实现这个应用才能达到和gitbook一样的效果呢？

### 1. 首先如何生成界面。

如果用flutter呈现界面，就意味着需要执行dart代码，而用户如果自定义界面，应用就需要运行用户自己编写的dart文件，这岂不是需要动态执行dart代码？这把我吓了一跳，dart并不像js天生就可以动态执行，动态执行dart代码和实现插件系统几乎没什么两样！我一下蔫了。

但我仔细一想，并不需要！用户的dart代码只具有模板性质，应用只需要把用户的dart文件像处理字符串那样填充好数据，接着生成新的dart代码文件，然后直接运行即可。也就是说应用其实只需要生成一个flutter工程，将必要的dart代码文件放入指定路径，运行这个工程就可以了！想到这里我又兴奋了起来。

### 2. 如何填充数据

数据应当是json，这样是为了让用户方便自定义数据和界面。那应用方面则需要处理类似这样的字符串`if (page.title) Text(page.title)`，使得在dart语言的上下文中可以正常编译。这里有两个问题需要处理：

**1. 非空判断** `if (page.title)`这种写法在模板语法中非常常见，dart只能接受`page.title != null`。只能牺牲已有的习惯，按照dart风格来。

**2. 取值操作** `page.title.name.size`中的`.`处理起来有点棘手，如果`page`对象是json，那运行起来的代码只能是`page['title']['name']['size']`。目前可以先将`page`当成类对象，规避这个问题。类对象的属性是固定的，数据扩展性无疑会打折扣。先不考虑这个问题了。

### 3. 页面主体如何呈现

刚才想的只是书页的装饰部分，页面内容才是主体部分是，才是最关键的。原来的gitbook只需要用一个简单的`page.content`填充在模板文件中即可，但是如果改成flutter后要如何实现呢？

这个问题花了我不少时间，因为我没有想清楚`page.content`的特殊性。它形式上看起来是作为数据，然而这个数据是`生成页面`，因为它是一系列html标签。浏览器在处理最终的html文本的时候并不会区分哪些是生成的，哪些是模板的。如果对应起来，我需要把`page.content`的值处理成一系列的dart代码文本，即`<p>...</p><h1>Title</h1>`转换成flutter控件`Text(),Text()`。我很快想起来，已经存在将html标签文本转成flutter控件的控件。这个问题看来也能解决，太棒了！

不过我突然想到风格主题自定义的问题。转换html标签文本的控件是生成了一个巨大的富文本控件`RichText`，它的子节点是一系列的`Span`控件。**外部要如何自定义这些`Span`控件的风格呢？**

### 3. 动态还是静态

原来的gitbook是生成了很多很多的页面，现在用了flutter, 只需要动态的更换page对象即可实现书页的更新了。这样就有一个问题，将来托管在服务器上的书页站点到底是静态还是动态的？

起初，想当然的认为当然是动态好，但仔细想想不得了，如果是动态的，那意味着当前页面不管如何呈现都需要把书页的全部内容都载入进来，因为服务器始终都是静态服务器，我们的“动态”只是页面动态更新。而实现成像gitbook那样的静态书页，没有浏览的书页内容是不会加载的，这就大大减轻了请求的负载和时间。**所以应用的一个重要的功能是能将当前flutter页面转成静态的html页面**。现在还没有头绪。

我觉得这个想法非常不错，可行性也非常大，需要抓紧时间验证一下。

7.25
---
15:48

似乎还是不行，因为没有办法解决多个静态页面及相互跳转的问题，flutter的web应用更适合做单页面呈现，所以Web flutter更适合做[应用而不是站点](https://www.reddit.com/r/FlutterDev/comments/ueb13t/will_flutter_ever_be_suitable_for_simple_static)

18:29

昏聩的一天结束了，静态模板的方案一点进展也没有，全部注意力都在考虑flutter的方案。快下班的时候验证了一下，非要做也不是不行，就是把数据以json格式写入flutter工程的资源目录下，然后在切换目录的时候加载对应的html数据，再通过flutter展示出来。这一个方案怎么看都有点脱裤子放屁的意味。唉，只能再按照老路继续走了。
