title: 性能问题
date: 2022-07-27 9:10:58
category: Tech
---

昨天花了一整天的时间，终于把之前的术语表功能实现了。一开始没理解，要如何做到一旦匹配术语不会重复生成html的链接文本，后来才终于明白了门道：先把原始文本转成dom树，再直接操作dom树，最后再转回文本。而且操作dom树的时候是先用单个术语整体的对整个dom进行遍历并标记，最后再做移除操作，然后再循环下一个术语。这个过程有点痛苦，很多js的操作没法对应到dart，譬如那个`insertBefore`操作，虽然方法名能对应上，调用对象角色是不一样的！而且，明明生成的可能是多个节点对象，但参数却只接收单个元素，幸亏找到了叫`DocumentFragment`的类。

我立马用康拉丁那本书运行了一下，结果让我大跌眼镜！与我预想的快的飞起的效果不同，运行如老牛拉破车，比gitbook还慢！本来我就是嫌gitbook太慢才搞dartbook的呀，这叫哪门子的`dart`？！昨晚又花了2,3小时调试了一下，都没顾着和小孩玩（本来也不想玩）。gitbook每页生成小于1s，我的dartbook每页生成竟然大于5s！发现原因是dart的`HtmlEscape`极其慢，注掉之后很快达到1.3s左右，仍然比gitbook慢很多。调了半天，发现是正则表达式的问题。很奇怪，一旦用到正则就很慢，正则匹配单个术语用到2-3毫秒，500多个术语一共消耗1s以上。是我正则写得有问题吗？gitbook生成每一页的时候可还运行了不止一个Modifier的操作呢，今天把这个问题解决一下！

说到调试，我也是没有直击要害，明明能够比较快地通过注释某些行就可以定位的问题的， 我非要写就一坨时间显示方法，效率低下还浪费时间，越写码越成强迫症！

10:55
---

问题解决了！原来重复的正则应当缓存起来，否则创建一个新的正则会非常慢，可能对正则表达式有编译环节。这下就嗖嗖得快啦！
